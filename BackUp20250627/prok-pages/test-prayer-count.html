<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¤‘ë³´ê¸°ë„ì ì¹´ìš´íŠ¸ í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .prayer-count {
      font-size: 2rem;
      font-weight: bold;
      color: #4caf50;
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: #e8f5e8;
      border-radius: 10px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    button {
      background: #4caf50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #45a049; }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ™ ì¤‘ë³´ê¸°ë„ì ì¹´ìš´íŠ¸ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="prayer-count">
      í˜„ì¬ ì¤‘ë³´ê¸°ë„ì: <span id="prayerCount">0</span>ëª…
    </div>
    
    <div id="status" class="status info">Firebase ì—°ê²° ì¤‘...</div>
    
    <div>
      <button onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
      <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
      <button onclick="refreshCount()">ì¹´ìš´íŠ¸ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    
    <h3>ë¡œê·¸</h3>
    <div id="log" class="log"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyCrJIhyTYQ4bTUW4jarFqluD97xKao2kF0",
      authDomain: "prokworldmap.firebaseapp.com",
      databaseURL: "https://prokworldmap-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "prokworldmap",
      storageBucket: "prokworldmap.appspot.com",
      messagingSenderId: "728381830842",
      appId: "1:728381830842:web:cfcb810657e1608d91f483",
      measurementId: "G-SVTPDV602Y"
    };

    let database;
    let userKey;
    let isConnected = false;

    // ë¡œê·¸ í•¨ìˆ˜
    function log(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.innerHTML += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
      console.log(message);
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(message, type = 'info') {
      const statusElement = document.getElementById('status');
      statusElement.textContent = message;
      statusElement.className = `status ${type}`;
    }

    // Firebase ì´ˆê¸°í™”
    function initFirebase() {
      try {
        if (!window.firebase) {
          throw new Error('Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        
        if (!window.firebase.apps.length) {
          window.firebase.initializeApp(firebaseConfig);
        }
        
        database = window.firebase.database();
        log('Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        return true;
      } catch (error) {
        log(`Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
        updateStatus('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
        return false;
      }
    }

    // ì‚¬ìš©ì ë“±ë¡
    function registerUser() {
      if (!database) {
        log('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      userKey = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      database.ref('prayerUsers').child(userKey).set({
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        page: 'test-prayer-count.html'
      }).then(() => {
        log(`ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ: ${userKey}`);
        updateStatus('ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ', 'success');
      }).catch((error) => {
        log(`ì‚¬ìš©ì ë“±ë¡ ì‹¤íŒ¨: ${error.message}`);
        updateStatus('ì‚¬ìš©ì ë“±ë¡ ì‹¤íŒ¨', 'error');
      });
    }

    // ì¤‘ë³´ê¸°ë„ì ìˆ˜ ê°ì‹œ
    function watchPrayerCount() {
      if (!database) {
        log('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      database.ref('prayerUsers').on('value', (snapshot) => {
        const count = snapshot.numChildren();
        const users = snapshot.val() || {};
        
        document.getElementById('prayerCount').textContent = count;
        log(`ì¤‘ë³´ê¸°ë„ì ìˆ˜ ì—…ë°ì´íŠ¸: ${count}ëª…`);
        
        if (count > 0) {
          updateStatus(`ì‹¤ì‹œê°„ ì¤‘ë³´ê¸°ë„ì ${count}ëª…`, 'success');
        } else {
          updateStatus('í˜„ì¬ ì¤‘ë³´ê¸°ë„ìê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
        }
        
        // ì‚¬ìš©ì ëª©ë¡ ë¡œê·¸
        const userList = Object.keys(users).map(key => ({
          key: key,
          timestamp: users[key].timestamp,
          userAgent: users[key].userAgent,
          page: users[key].page || 'unknown'
        }));
        
        log(`í™œì„± ì‚¬ìš©ì: ${userList.length}ëª…`);
        userList.forEach(user => {
          const timeAgo = Math.floor((Date.now() - user.timestamp) / 1000);
          log(`  - ${user.key} (${timeAgo}ì´ˆ ì „, ${user.page})`);
        });
        
        isConnected = true;
      }, (error) => {
        log(`ì¤‘ë³´ê¸°ë„ì ìˆ˜ ê°ì‹œ ì‹¤íŒ¨: ${error.message}`);
        updateStatus('ì‹¤ì‹œê°„ ê°ì‹œ ì‹¤íŒ¨', 'error');
        isConnected = false;
      });
    }

    // ì—°ê²° í…ŒìŠ¤íŠ¸
    function testConnection() {
      log('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
      
      if (!database) {
        if (!initFirebase()) {
          return;
        }
      }
      
      database.ref('.info/connected').on('value', (snapshot) => {
        const connected = snapshot.val();
        if (connected) {
          log('Firebase ì—°ê²° ì„±ê³µ');
          updateStatus('Firebase ì—°ê²°ë¨', 'success');
          
          if (!userKey) {
            registerUser();
          }
          
          if (!isConnected) {
            watchPrayerCount();
          }
        } else {
          log('Firebase ì—°ê²° ëŠì–´ì§');
          updateStatus('Firebase ì—°ê²° ëŠì–´ì§', 'error');
        }
      });
    }

    // ì¹´ìš´íŠ¸ ìƒˆë¡œê³ ì¹¨
    function refreshCount() {
      log('ì¹´ìš´íŠ¸ ìƒˆë¡œê³ ì¹¨...');
      
      if (!database) {
        log('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }
      
      database.ref('prayerUsers').once('value').then((snapshot) => {
        const count = snapshot.numChildren();
        document.getElementById('prayerCount').textContent = count;
        log(`ìƒˆë¡œê³ ì¹¨ëœ ì¤‘ë³´ê¸°ë„ì ìˆ˜: ${count}ëª…`);
        updateStatus(`ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ: ${count}ëª…`, 'success');
      }).catch((error) => {
        log(`ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${error.message}`);
        updateStatus('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨', 'error');
      });
    }

    // ë¡œê·¸ ì§€ìš°ê¸°
    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      log('í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
      
      // Firebase ì´ˆê¸°í™”
      if (initFirebase()) {
        // ì‚¬ìš©ì ë“±ë¡
        registerUser();
        
        // ì¤‘ë³´ê¸°ë„ì ìˆ˜ ê°ì‹œ
        watchPrayerCount();
      }
    });

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì‚¬ìš©ì ì œê±°
    window.addEventListener('beforeunload', function() {
      if (database && userKey) {
        database.ref('prayerUsers').child(userKey).remove();
        log('ì‚¬ìš©ì ì œê±°ë¨');
      }
    });

    // ì£¼ê¸°ì ìœ¼ë¡œ ì‚¬ìš©ì ìƒíƒœ ê°±ì‹ 
    setInterval(() => {
      if (database && userKey) {
        database.ref('prayerUsers').child(userKey).update({
          timestamp: Date.now()
        });
      }
    }, 30000); // 30ì´ˆë§ˆë‹¤

    // ì˜¤ë˜ëœ ì‚¬ìš©ì ì •ë¦¬ (5ë¶„ ì´ìƒ ë¹„í™œì„±)
    setInterval(() => {
      if (database) {
        database.ref('prayerUsers').once('value').then((snapshot) => {
          const users = snapshot.val() || {};
          const now = Date.now();
          const inactiveThreshold = 5 * 60 * 1000; // 5ë¶„

          Object.keys(users).forEach(userKey => {
            const user = users[userKey];
            if (now - user.timestamp > inactiveThreshold) {
              database.ref('prayerUsers').child(userKey).remove();
              log(`ë¹„í™œì„± ì‚¬ìš©ì ì œê±°: ${userKey}`);
            }
          });
        });
      }
    }, 60000); // 1ë¶„ë§ˆë‹¤
  </script>
</body>
</html> 