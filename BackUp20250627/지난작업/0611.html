<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ê¸°ë…êµì¥ë¡œíšŒ í•´ì™¸ ì„ êµë™ì—­ì ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        h1.top-title {
            position: absolute; top: 18px; left: 0; right: 0;
            text-align: center; color: white; font-size: 2rem;
            text-shadow: 0 2px 8px rgba(0,0,0,0.6);
            z-index: 1050; pointer-events: none;
            margin: 0; padding: 0; font-family: inherit;
            display: flex; align-items: center; justify-content: center; gap: 14px;
        }
        .title-logo { height: 40px; width: auto; vertical-align: middle;
            pointer-events: none; border-radius: 8px; padding: 4px 8px; box-sizing: content-box;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        @media (max-width: 600px) {
            h1.top-title { font-size: 1.1rem; gap:7px;}
            .title-logo { height: 26px; padding:1px 3px;}
        }
        .flag-icon { width: 20px; height: 15px; vertical-align: middle; margin-right: 5px; }
        .popup-list { margin-top: 4px; padding: 2px 0; }
        .popup-list:hover { cursor: pointer; color: blue; text-decoration: underline; }
        .detail-popup {
            position: absolute; background: #fff; border: 1px solid #ccc; border-radius: 8px;
            padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000;
            display: none; width: 320px;
        }
        .detail-popup h3 { margin-top: 0; }
        .detail-popup .popup-img-area {
            width: 100%; height: 180px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; background: #f6f6f6;
            border-radius: 8px; margin-bottom: 10px;
        }
        .detail-popup .popup-img-area img {
            width: 100%; height: 100%;
            object-fit: cover; object-position: center; border-radius: 8px;
            background: #eee; display: block;
        }
        .detail-popup .close-btn {
            position: absolute; top: 10px; right: 10px; cursor: pointer;
            color: #333; font-weight: bold; font-size: 16px;
        }
        .floating-missionary-wrapper {
            position: absolute; z-index: 999; pointer-events: none;
        }
        .floating-missionary-content {
            display: flex; align-items: center; gap: 8px; padding: 6px 12px;
            background: rgba(255, 255, 255, 0.95); border-radius: 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2); border: 2px solid #ccc;
            opacity: 1; transition: opacity 0.8s;
                opacity: 0;
            animation: floatFadeInOut 4s both;
                }
                @keyframes floatFadeInOut {
                    0%   { opacity: 0; transform: translateY(10px) scale(0.95);}
                    10%  { opacity: 1; transform: translateY(-2px) scale(1);}
                    15%  { opacity: 1; transform: translateY(-5px) scale(1.01);}
                    100% { opacity: 0; transform: translateY(-18px) scale(1.03);}
                }


        
        .floating-missionary-content.recent { border-color: orange; }
        .floating-missionary-content img {
            width: 24px; height: 24px; border-radius: 50%;
        }
        .floating-missionary-content .name { font-weight: bold; color: #333; }
        .floating-missionary-content.recent .name { color: orange; }
        .floating-missionary-content .prayer { font-size: 13px; color: #555; }
        .presbytery-floating { opacity: 0; animation: fadePopup 0.5s forwards; }
        .presbytery-floating.hide { opacity: 0 !important; transition: opacity 0.8s; }
        @keyframes fadePopup {
            from { opacity: 0; transform: scale(0.92);}
            to   { opacity: 1; transform: scale(1);}
        }
        .fullscreen-btn {
            position: fixed; bottom: 32px; right: 32px; width: 48px; height: 48px;
            background: rgba(40,40,40,0.6); color: white; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18); cursor: pointer; z-index: 1200;
            user-select: none; transition: background 0.2s;
        }
        .fullscreen-btn:hover { background: rgba(40,40,40,0.8);}
        @media (max-width: 600px) {
            .fullscreen-btn { right: 12px; bottom: 12px; width:40px; height:40px; font-size:1.5rem;}
        }

        /* êµ­ê°€ë³„/ë…¸íšŒë³„ í‘œë¥¼ í•œ ì¤„ë¡œ ë‚˜ë€íˆ */
        .missionary-tables-row {
            position: absolute;
            top: 60px; left: 24px; z-index: 1100;
            display: flex; flex-direction: row; gap: 18px;
        }

        /* -------- êµ­ê°€ë³„ íŒŒì†¡í˜„í™© í‘œ -------- */
        .country-table-overlay {
            background: rgba(255,255,255,0.2);  /* êµ­ê°€ë³„ íˆ¬ëª…ë„ */
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 18px 20px 12px 20px;
            min-width: 180px;
            max-width: 340px;
            max-height: 100vh;
            overflow-y: auto;
            font-size: 10px;
            transition: opacity 0.2s;
        }
        .country-table-overlay table { width: 100%; border-collapse: collapse;}
        .country-table-overlay th, .country-table-overlay td { padding: 5px 6px; }
        .country-table-overlay th { font-weight: bold; color: #0e325c;}
        .country-table-overlay .flag-icon { width: 22px; height: 15px; vertical-align: middle; margin-right: 5px; }
        .country-table-overlay .bold { font-weight: bold; color:#003366;}

        /* -------- ë…¸íšŒë³„ íŒŒì†¡í˜„í™© í‘œ -------- */
        .presbytery-table-overlay {
            background: rgba(245,250,255,0.2); /* ë…¸íšŒë³„ íˆ¬ëª…ë„ì™€ ë°°ê²½ìƒ‰ ë¶„ë¦¬ */
            border-radius: 12px;
            
            box-shadow: 0 2px 8px rgba(0,0,0,0.0.15);
            padding: 18px 20px 12px 20px;
            min-width: 180px;
            max-width: 340px;
            max-height: 30vh;
            overflow-y: auto;
            font-size: 10px;
            transition: opacity 0.2s;
        }
        .presbytery-table-overlay table { width: 100%; border-collapse: collapse;}
        .presbytery-table-overlay th, .presbytery-table-overlay td { padding: 5px 6px; }
        .presbytery-table-overlay th { font-weight: bold; color:#00509e;}
        .presbytery-table-overlay .bold { font-weight: bold; color:#00509e;}
        .presbytery-table-overlay .presbytery-click { cursor:pointer; text-decoration:underline; }

        @media (max-width: 900px) {
          .country-table-overlay, .presbytery-table-overlay {
            max-width: 200px; font-size: 12px; padding: 12px 7px 8px 10px;
          }
          .country-table-overlay .flag-icon, .presbytery-table-overlay .flag-icon { width: 15px; height: 11px; }
        }
        @media (max-width: 650px) {
          .country-table-overlay, .presbytery-table-overlay {
            min-width: 120px; max-width: 120px; font-size: 10.5px;
          }
          .country-table-overlay .flag-icon, .presbytery-table-overlay .flag-icon { width: 11px; height: 8px; }
          .country-table-overlay th, .presbytery-table-overlay th { display: none;}
        }
        @media (max-width: 480px) {
          .country-table-overlay, .presbytery-table-overlay { display: none !important; }
        }

        /* ë²”ë¡€ */
        .leaflet-legend-box {
            display: flex; align-items: center;
            background: rgba(255,255,255,0.95);
            border-radius: 7px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.10);
            padding: 7px 12px; font-size: 13px;
            margin-bottom: 5px;
        }
        .legend-orange {
            display: inline-block;
            width: 18px; height: 18px;
            border: 2px solid orange;
            border-radius: 7px;
            margin-right: 8px;
            background: transparent;
            vertical-align: middle;
        }

        /* ì§€ë„ ì •ë³´(footerbanner) */
        /* ì§€ë„ í•˜ë‹¨ ì•ˆë‚´ë¬¸êµ¬(footer-banner) ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .footer-banner {
            position: fixed;                  /* í™”ë©´ì— ê³ ì • */
            left: 50%;                        /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬(ì¢Œì¸¡ ê¸°ì¤€) */
            bottom: 10px;                     /* í™”ë©´ ì•„ë˜ì—ì„œ 22px ë„ì›€ */
            transform: translateX(-50%);      /* ì •í™•íˆ ì¤‘ì•™ìœ¼ë¡œ ì´ë™ */
            background: linear-gradient(
                                        90deg,
                                        rgba(248,248,248,0.42) 100%,    /* ë°ì€ íšŒìƒ‰, íˆ¬ëª…ë„ 82% */
                                        rgba(230,240,250,0.82) 100%    /* ì—°í•œ íŒŒë‘, íˆ¬ëª…ë„ 62% */
                                        );
            color: rgb(0, 0, 0);                      /* ê¸€ììƒ‰ */
            font-weight: 500;                 /* êµµì€ ê¸€ì”¨ */
            font-size: 0.7rem;                  /* ê¸°ë³¸ ê¸€ì í¬ê¸° */
            border-radius: 10px;              /* ë‘¥ê·¼ í…Œë‘ë¦¬ */
            padding: 1px 3px 1px 3px;     /* ìœ„, ì˜¤ë¥¸ìª½, ì•„ë˜, ì™¼ìª½ íŒ¨ë”© */
            box-shadow: 0 3px 16px rgba(0,32,64,0.14);  /* ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì */
            border: 2px solid #dfdfe2;        /* ì—°í•œ íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
            z-index: 3000;                    /* ê°€ì¥ ìœ„ì— í‘œì‹œ */
            text-align: center;               /* ê°€ìš´ë° ì •ë ¬ */
            letter-spacing: 0.01em;           /* ê¸€ì ê°„ê²© */
            line-height: 0.6;                   /* ì¤„ ê°„ê²© */
            max-width: 200vw;                  /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ(ë°˜ì‘í˜•) */
            white-space: pre-line;            /* ì¤„ë°”ê¿ˆ ì§€ì› */
        }

        /* ëª¨ë°”ì¼(í­ 600px ì´í•˜)ì—ì„œì˜ ì•ˆë‚´ë¬¸êµ¬ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        @media (max-width: 600px) {
        .footer-banner {
            font-size: 0.95rem;              /* ê¸€ì í¬ê¸° ì•½ê°„ ì‘ê²Œ */
            padding: 10px 10px 10px 10px;    /* íŒ¨ë”© ê°ì†Œ */
            border-radius: 11px;             /* ëª¨ì„œë¦¬ ë°˜ê²½ ì‘ê²Œ */
            max-width: 99vw;                 /* ê±°ì˜ ì „ì²´ í­ ì‚¬ìš© */
        }
        }


    </style>
</head>
<body>
    <div id="map"></div>
    <div id="detailPopup" class="detail-popup"></div>
    <h1 class="top-title">
        <img src="logo.svg" alt=" " class="title-logo">
        í•œêµ­ê¸°ë…êµì¥ë¡œíšŒ í•´ì™¸ ì„ êµë™ì—­ì ì§€ë„
    </h1>
    <div class="missionary-tables-row">
      <div id="missionary-table-country" class="country-table-overlay"></div>
      <div id="missionary-table-presbytery" class="presbytery-table-overlay"></div>
    </div>
    <div id="fullscreenBtn" class="fullscreen-btn" title="ì „ì²´í™”ë©´ ë³´ê¸°">ğŸ–µ</div>
    <div id="exitFullscreenBtn" class="fullscreen-btn" style="display:none;" title="ì „ì²´í™”ë©´ ì¢…ë£Œ">âœ–</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    const FLOAT_COUNT = 1;
    const FLOAT_DISPLAY_TIME = 3000;
    const FLOAT_INTERVAL = 3500;
    const PRESBYTERY_FLOAT_DURATION = 5000;
    const PRESBYTERY_PAUSE_EXTRA = 7000;
    const POPUP_ROTATE_INTERVAL = 3000;
    let pause = false, currentIndex = 0, byAutoRotate = false;
    let presbyteryTimer = null;

    const latlngs = {
        "ì¼ë³¸": [36.2048, 138.2529], "ì¤‘êµ­": [35.8617, 104.1954], "ëŒ€ë§Œ": [23.6978, 120.9605], "ëª½ê³¨": [46.8625, 103.8467], "ëŸ¬ì‹œì•„": [61.5240, 105.3188],
        "í•„ë¦¬í•€": [12.8797, 121.7740], "íƒœêµ­": [15.8700, 100.9925], "ìº„ë³´ë””ì•„": [12.5657, 104.9910], "ë¼ì˜¤ìŠ¤": [19.8563, 102.4955], "ì¸ë„": [20.5937, 78.9629],
        "ì¸ë„ë„¤ì‹œì•„": [-0.7893, 113.9213], "íŒŒí‚¤ìŠ¤íƒ„": [30.3753, 69.3451], "ë™í‹°ëª¨ë¥´": [-8.8742, 125.7275], "ë„¤íŒ”": [28.3949, 84.1240], "ë§ë ˆì´ì‹œì•„": [4.2105, 101.9758],
        "ë‰´ì§ˆëœë“œ": [-40.9006, 174.8860], "í˜¸ì£¼": [-25.2744, 133.7751], "ì´ìŠ¤ë¼ì—˜": [31.0461, 34.8516], "ë…ì¼": [51.1657, 10.4515], "í—ê°€ë¦¬": [47.1625, 19.5033],
        "ë¶ˆê°€ë¦¬ì•„": [42.7339, 25.4858], "ë¶€ë¥´í‚¤ë‚˜íŒŒì†Œ": [12.2383, -1.5616], "ì¼€ëƒ": [0.0236, 37.9062], "ëª¨ë¦¬íƒ€ë‹ˆ": [21.0079, -10.9408], "ë¼ì´ë² ë¦¬ì•„": [6.4281, -9.4295],
        "ë§ë¼ìœ„": [-13.2543, 34.3015], "ìš°ê°„ë‹¤": [1.3733, 32.2903], "ë¯¸êµ­": [37.0902, -95.7129], "ì¿ ë°”": [21.5218, -77.7812]
    };
    const countryFlags = {
        "ì¼ë³¸": "jp", "ì¤‘êµ­": "cn", "ëŒ€ë§Œ": "tw", "ëª½ê³¨": "mn", "ëŸ¬ì‹œì•„": "ru", "í•„ë¦¬í•€": "ph", "íƒœêµ­": "th", "ìº„ë³´ë””ì•„": "kh", "ë¼ì˜¤ìŠ¤": "la", "ì¸ë„": "in",
        "ì¸ë„ë„¤ì‹œì•„": "id", "íŒŒí‚¤ìŠ¤íƒ„": "pk", "ë™í‹°ëª¨ë¥´": "tl", "ë„¤íŒ”": "np", "ë§ë ˆì´ì‹œì•„": "my", "ë‰´ì§ˆëœë“œ": "nz", "í˜¸ì£¼": "au", "ì´ìŠ¤ë¼ì—˜": "il", "ë…ì¼": "de",
        "í—ê°€ë¦¬": "hu", "ë¶ˆê°€ë¦¬ì•„": "bg", "ë¶€ë¥´í‚¤ë‚˜íŒŒì†Œ": "bf", "ì¼€ëƒ": "ke", "ëª¨ë¦¬íƒ€ë‹ˆ": "mr", "ë¼ì´ë² ë¦¬ì•„": "lr", "ë§ë¼ìœ„": "mw", "ìš°ê°„ë‹¤": "ug", "ë¯¸êµ­": "us", "ì¿ ë°”": "cu"
    };

    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const detailPopupElement = document.getElementById('detailPopup');

    fetch('https://docs.google.com/spreadsheets/d/1OXDGD7a30n5C--ReXdYRoKqiYNLt9aqY5ffxYN0bZF8/export?format=csv')
    .then(res => res.text())
    .then(csv => {
        const data = Papa.parse(csv, {header:true, skipEmptyLines:true}).data;

        const countryCounts = {};
        data.forEach(item => {
            if(!item.country) return;
            countryCounts[item.country] = (countryCounts[item.country] || 0) + 1;
        });
        const countryList = Object.keys(countryCounts).sort((a, b) => a.localeCompare(b, 'ko'));
        let countryTable = `<table><thead><tr><th></th><th>êµ­ê°€</th><th>ì¸ì›</th></tr></thead><tbody>`;
        countryList.forEach(country => {
            const flagCode = countryFlags[country];
            const flag = flagCode ? `<img class="flag-icon" src="https://flagcdn.com/w40/${flagCode}.png" alt="">` : '';
            countryTable += `<tr>
                <td>${flag}</td>
                <td class="bold">${country}</td>
                <td style="text-align:right;">${countryCounts[country]}</td>
            </tr>`;
        });
        countryTable += `</tbody></table>`;
        document.getElementById('missionary-table-country').innerHTML =
          `<div style="font-weight:bold;font-size:1.15em;margin-bottom:6px;text-align:center;">êµ­ê°€ë³„ íŒŒì†¡í˜„í™©</div>${countryTable}`;

        const presbyteryCounts = {};
        const presbyteryMembers = {};
        data.forEach(item => {
            if(!item.presbytery) return;
            presbyteryCounts[item.presbytery] = (presbyteryCounts[item.presbytery] || 0) + 1;
            if(!presbyteryMembers[item.presbytery]) presbyteryMembers[item.presbytery] = [];
            presbyteryMembers[item.presbytery].push(item);
        });
        const presbyteryList = Object.keys(presbyteryCounts).sort((a, b) => a.localeCompare(b, 'ko'));
        let presbyteryTable = `<table><thead><tr><th>ë…¸íšŒ</th><th>ì¸ì›</th></tr></thead><tbody>`;
        presbyteryList.forEach(presbytery => {
            presbyteryTable += `<tr>
                <td class="bold presbytery-click" data-presbytery="${presbytery}" style="cursor:pointer; color:#00509e;">${presbytery}</td>
                <td style="text-align:right;">${presbyteryCounts[presbytery]}</td>
            </tr>`;
        });
        presbyteryTable += `</tbody></table>`;
        document.getElementById('missionary-table-presbytery').innerHTML =
          `<div style="font-weight:bold;font-size:1.15em;margin-bottom:6px;text-align:center;">ë…¸íšŒë³„ íŒŒì†¡í˜„í™©</div>${presbyteryTable}`;

        // ---------------- ì§€ë„/í”Œë¡œíŒ… -------------------
        const missionaryNamesByCountry = {};
        data.forEach(item => {
            if (!item.country) return;
            if (!missionaryNamesByCountry[item.country]) missionaryNamesByCountry[item.country] = [];
            missionaryNamesByCountry[item.country].push(item.name);
        });

        const missionaryInfo = {};
        data.forEach(item => { missionaryInfo[item.name] = item; });

        const flatMissionaries = data
            .filter(info => info.name && info.country)
            .sort((a, b) => new Date(b.lastUpdate) - new Date(a.lastUpdate));

        function isRecent(updateDate) {
            if (!updateDate) return false;
            const days = (new Date() - new Date(updateDate)) / (1000 * 60 * 60 * 24);
            return days < 60;
        }

        window.showDetail = function(name, latlng) {
            const info = missionaryInfo[name] || {};
            const sentDate = info.sent_date ? new Date(info.sent_date) : null;
            const sentYear = sentDate ? sentDate.getFullYear() : 'ì •ë³´ ì—†ìŒ';
            const point = map.latLngToContainerPoint(latlng);
            const mapRect = map.getContainer().getBoundingClientRect();
            const imgSrc = info.image && info.image.trim() !== "" 
                ? info.image.trim() 
                : "https://via.placeholder.com/320x180.png?text=No+Photo";
            detailPopupElement.style.display = 'block';
            detailPopupElement.style.left = `${mapRect.left + point.x + 15}px`;
            detailPopupElement.style.top = `${mapRect.top + point.y - detailPopupElement.offsetHeight / 2}px`;
            detailPopupElement.innerHTML = `
                <div class="close-btn" onclick="closeDetail()">âœ–</div>
                <div class="popup-img-area">
                    <img src="${imgSrc}" alt="${name}" loading="lazy" 
                        onerror="this.onerror=null;this.src='https://via.placeholder.com/320x180.png?text=No+Photo';">
                </div>
                <h3 style="margin-top: 10px;">${name}</h3>
                <p><strong>íŒŒì†¡ë…„ë„:</strong> ${sentYear}ë…„</p>
                <p><strong>ì†Œì†:</strong> ${info.organization || 'ì •ë³´ ì—†ìŒ'}</p>
                <p><strong>ê¸°ë„ì œëª©:</strong> ${info.prayer || 'í˜„ì§€ ì •ì°©ê³¼ ê±´ê°•'}</p>
            `;
            pause = true;
        };
        window.closeDetail = function() {
            detailPopupElement.style.display = 'none';
            pause = false;
        };

        // êµ­ê°€ë³„ ë§ˆì»¤ ìƒì„±
        const markers = Object.entries(missionaryNamesByCountry).map(([country, names]) => {
            const latlng = latlngs[country] || [0, 0];
            const [lat, lng] = latlng;
            const flag = countryFlags[country] ? `<img class='flag-icon' src='https://flagcdn.com/w40/${countryFlags[country]}.png'>` : "";
            const popupContent = `${flag}<b>${country}</b><br>` +
                names.map(name => {
                    const info = missionaryInfo[name] || {};
                    const recentStyle = isRecent(info.lastUpdate) ? "style='color: orange; font-weight: bold'" : "";
                    return `<div class='popup-list' ${recentStyle} onclick='showDetail("${name}", [${lat}, ${lng}])'>${name}</div>`;
                }).join("");
            const marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(popupContent);
            marker.on('popupopen', () => {
                if (!byAutoRotate) pause = true;
                byAutoRotate = false;
            });
            marker.on('popupclose', () => { pause = false; });
            return marker;
        });

        map.on('click', () => {
            markers.forEach(marker => marker.closePopup());
            window.closeDetail();
        });

        setInterval(() => {
            if (!pause && markers.length > 0) {
                if (map.getContainer().querySelector('.leaflet-popup-content')) {
                    markers.forEach(m => m.closePopup());
                }
                byAutoRotate = true;
                markers[currentIndex].openPopup();
                currentIndex = (currentIndex + 1) % markers.length;
            }
        }, POPUP_ROTATE_INTERVAL);

        // ------ ì¼ë°˜ ìë™ í”Œë¡œíŒ… ------
        let floatingIndex = 0;
        setInterval(() => {
            if (pause || flatMissionaries.length === 0) return;
            for(let c=0; c<FLOAT_COUNT; c++) {
                const item = flatMissionaries[(floatingIndex + c) % flatMissionaries.length];
                const latlng = latlngs[item.country];
                if (!latlng) continue;
                const [lat, lng] = latlng;
                const recent = isRecent(item.lastUpdate);
                const point = map.latLngToContainerPoint([
                    lat + (Math.random() - 0.5) * 3,
                    lng + (Math.random() - 0.5) * 3
                ]);
                const wrapper = document.createElement("div");
                wrapper.className = "floating-missionary-wrapper";
                wrapper.style.left = `${point.x - 50}px`;
                wrapper.style.top = `${point.y - 20}px`;
                wrapper.innerHTML = `
                  <div class="floating-missionary-content ${recent ? 'recent' : ''}">
                    <img src="https://cdn-icons-png.flaticon.com/128/149/149071.png" alt="icon">
                    <div>
                      <div class="name">${item.name}</div>
                      <div class="prayer">${item.prayer || 'í˜„ì§€ ì •ì°©ê³¼ ê±´ê°•'}</div>
                    </div>
                  </div>
                `;
                // Fade in/out
                wrapper.style.opacity = "0";
                map.getContainer().appendChild(wrapper);
                setTimeout(()=>{wrapper.style.opacity="1";}, 40);
                setTimeout(() => {
                  wrapper.style.opacity="0";
                  setTimeout(()=>wrapper.remove(),800);
                }, FLOAT_DISPLAY_TIME);
            }
            floatingIndex = (floatingIndex + FLOAT_COUNT) % flatMissionaries.length;
        }, FLOAT_INTERVAL);

        // ------ ë…¸íšŒë³„ íŒŒì†¡í˜„í™© "ë…¸íšŒ" í´ë¦­ ì‹œ ì†Œì† ì„ êµì‚¬ ê¸°ë„ì œëª© í”Œë¡œíŒ… ------
        document.querySelectorAll('.presbytery-click').forEach(cell => {
            cell.addEventListener('click', function(e){
                pause = true;
                if(presbyteryTimer) clearTimeout(presbyteryTimer);

                const presbytery = e.target.getAttribute('data-presbytery');
                const missionaries = presbyteryMembers[presbytery] || [];

                // ê°™ì€ ë‚˜ë¼ ê·¸ë£¹í•‘ â†’ ê²¹ì¹˜ì§€ ì•Šê²Œ ë¶„ì‚°
                const countryGroups = {};
                missionaries.forEach(item => {
                    if (!countryGroups[item.country]) countryGroups[item.country] = [];
                    countryGroups[item.country].push(item);
                });

                document.querySelectorAll('.floating-missionary-wrapper').forEach(div => div.remove());

                Object.entries(countryGroups).forEach(([country, group]) => {
                    const latlng = latlngs[country];
                    if (!latlng) return;
                    const [lat, lng] = latlng;
                    // Nëª…ì¼ ê²½ìš° ìœ„ì—ì„œ ì•„ë˜ë¡œ ì¼ì • ê°„ê²© ë¶„ì‚°
                    const baseY = -60;
                    const gapY = 45;
                    group.forEach((item, i) => {
                        const recent = isRecent(item.lastUpdate);
                        const point = map.latLngToContainerPoint([
                            lat + (Math.random() - 0.5) * 2.4,
                            lng + (Math.random() - 0.5) * 2.4
                        ]);
                        const wrapper = document.createElement("div");
                        wrapper.className = "floating-missionary-wrapper presbytery-floating";
                        wrapper.style.left = `${point.x - 60}px`;
                        wrapper.style.top = `${point.y + baseY + i * gapY}px`;
                        wrapper.innerHTML = `
                          <div class="floating-missionary-content ${recent ? 'recent' : ''}">
                            <img src="https://cdn-icons-png.flaticon.com/128/149/149071.png" alt="icon">
                            <div>
                              <div class="name">${item.name}</div>
                              <div class="prayer">${item.prayer || 'í˜„ì§€ ì •ì°©ê³¼ ê±´ê°•'}</div>
                            </div>
                          </div>
                        `;
                        wrapper.style.opacity="0";
                        map.getContainer().appendChild(wrapper);
                        setTimeout(()=>{wrapper.style.opacity="1";},40);
                        setTimeout(()=>{
                            wrapper.style.opacity="0";
                            setTimeout(()=>{ wrapper.remove(); }, 850);
                        }, PRESBYTERY_FLOAT_DURATION);
                    });
                });

                presbyteryTimer = setTimeout(()=>{
                    pause = false;
                }, PRESBYTERY_FLOAT_DURATION + PRESBYTERY_PAUSE_EXTRA);
            });
        });

        // ------ ë²”ë¡€ ------
        // leaflet control ì˜ì—­ì— legend ì¶”ê°€
        const legend = L.control({position: 'topright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'leaflet-legend-box');
            div.innerHTML = `<span class="legend-orange"></span> <span>ìµœê·¼ 1ê°œì›” ì†Œì‹</span>`;
            return div;
        };
        legend.addTo(map);

    }); // fetch end

    document.getElementById('fullscreenBtn').onclick = function() {
        document.documentElement.requestFullscreen();
    };
    document.getElementById('exitFullscreenBtn').onclick = function() {
        if (document.fullscreenElement) document.exitFullscreen();
    };
    document.addEventListener('fullscreenchange', () => {
        const isFull = !!document.fullscreenElement;
        document.getElementById('fullscreenBtn').style.display = isFull ? "none" : "flex";
        document.getElementById('exitFullscreenBtn').style.display = isFull ? "flex" : "none";
        if (typeof map !== "undefined" && map.invalidateSize) {
            setTimeout(()=>map.invalidateSize(), 400);
        }
    });
    </script>

    <div class="footer-banner">
    ì´ ì§€ë„ëŠ” ì „ì„¸ê³„ì— í©ì–´ì ¸ ì„ êµì‚¬ì—­ì„ ê°ë‹¹í•˜ê³  ìˆëŠ” ì´íšŒíŒŒì†¡ í•´ì™¸ì„ êµë™ì—­ìë‹˜ë“¤ì˜ í˜„í™©ì„ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.<br>
    ê·€í•œ ì„ êµì‚¬ì—­ì„ ìœ„í•´ ê¸°ë„ë¡œ í•¨ê»˜ í•˜ì—¬ ì£¼ì‹œê¸°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
    </div>


</body>
</html>